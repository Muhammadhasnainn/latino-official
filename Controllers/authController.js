import User from "../Models/User.js";
import otpGenerator from "otp-generator";
import nodemailer from "nodemailer";
import bcrypt from "bcryptjs";

var transporter = nodemailer.createTransport({
  service: "gmail",
  port: 587,
  secure: false, // true for 465, false for other ports
  auth: {
    user: "themohdhasnain@gmail.com",
    pass: process.env.PASSWORD,
  },
});

export async function generateOTP(req, res) {
  const user = await User.findOne({ email: req.query.email });
  if (!user) return res.status(500).send("User with this email does't exist!");

  req.app.locals.OTP = await otpGenerator.generate(6, {
    lowerCaseAlphabets: false,
    upperCaseAlphabets: false,
    specialChars: false,
  });

  await transporter.sendMail({
    from: "themohdhasnain@gmail.com", // sender address
    to: req.query.email, // list of receivers
    subject: "Reset Password", // Subject line
    html: `
    <img src='cid:data:image/png;base64,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' 
     width="200px" style="margin-top: 20px"/>
   <p style="margin-top: 10px; font-size: 1rem;">Your Password Reset OTP is this: ${req.app.locals.OTP}</p>`, // plain text body
    attachments: [
      {
        filename: "logo.png",
        path: "data:image/png;base64,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",
        cid: "data:image/png;base64,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", //same cid value as in the html img src
      },
    ],
  });

  res.status(201).send({ code: req.app.locals.OTP });
}

export async function verifyOTP(req, res) {
  const { code } = req.query;
  if (parseInt(req.app.locals.OTP) === parseInt(code)) {
    req.app.locals.OTP = null;
    req.app.locals.resetSession = true;
    return res.status(201).send({ msg: "Verify Successsfully!" });
  }
  return res.status(400).send({ error: "Invalid OTP" });
}

export async function createResetSession(req, res) {
  if (req.app.locals.resetSession) {
    return res.status(201).send({ flag: req.app.locals.resetSession });
  }
  return res.status(440).send({ error: "Session expired!" });
}

export async function resetPassword(req, res) {
  try {
    if (!req.app.locals.resetSession)
      return res.status(440).send({ error: "Session expired!" });

    const { email, password } = req.body;

    try {
      let user = await User.findOne({ email });
      const salt = await bcrypt.genSalt(10);
      let securePassword = await bcrypt.hash(password, salt);

      user = { ...user._doc, password: securePassword };
      await User.findOneAndUpdate({ email }, { $set: user }, { new: true });
      req.app.locals.resetSession = false;

      res.json({ message: "Sucessfull!" });
    } catch (error) {
      return res.status(500).send({ error });
    }
  } catch (error) {
    return res.status(401).send({ error });
  }
}

export async function ChangePassword(req, res) {
  const { email, oldpassword, newpassword } = req.body;

  let user = await User.findOne({ email });

  if (!user) return res.status(400).send("User doesn't exist!");

  const passwordCompare = await bcrypt.compare(oldpassword, user.password);
  if (!passwordCompare) {
    return res.status(400).json({ msg: "Wrong Password!" });
  }

  const salt = await bcrypt.genSalt(10);
  let securePassword = await bcrypt.hash(newpassword, salt);

  user = { ...user._doc, password: securePassword };
  await User.findOneAndUpdate({ email }, { $set: user }, { new: true });

  res.json({ msg: "Password Successfully Updated!" });
}
